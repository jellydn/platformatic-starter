name: Test
on:
  push:
    branches:
      - main
      - dev

jobs:
  typecheck:
    name: Ê¦ TypeScript
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.0

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: â” Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¥ Install pnpm
        run: npm install -g pnpm

      - name: ğŸ“¥ Download deps
        run: pnpm install

      - name: ğŸ” Type check
        run: pnpm run typecheck

  lint:
    name: â¬£ ESLint
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.0

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: "50"

      - name: ğŸ›  Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¥ Install pnpm
        run: npm install -g pnpm

      - name: ğŸ“¥ Download deps
        run: pnpm install

      - name: ğŸ”¬ Lint
        run: pnpm run lint

  test-ci:
    name: Test CI
    runs-on: ubuntu-latest
    needs: [typecheck, lint]
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: â” Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¥ Install pnpm
        run: npm install -g pnpm

      - name: ğŸ“¥ Download deps
        run: pnpm install

      - name: Create Database Directory
        run: |
          mkdir -p db
          touch db/movies.sqlite

      - name: Install hurl
        run: pnpm add @orangeopensource/hurl

      - name: Run test
        env:
          DATABASE_URL: sqlite://db/movies.sqlite
          PLT_SERVER_LOGGER_LEVEL: info
          PORT: 3042
          PLT_SERVER_HOSTNAME: 127.0.0.1
        run: make test-ci
